{% extends "base.html" %}

{% block title %}Pre-Revenue Metrics - PMS Portal{% endblock %}

{% block content %}
<div class="tab-container">
    <!-- Header -->
    <div class="tab-header">
        <h1>Pre-Revenue Metrics</h1>
        <div class="tab-actions">
            <a href="/enquiry/" class="btn btn-secondary btn-sm">View Enquiries</a>
            <a href="/enquiry/new" class="btn btn-primary btn-sm">+ New Enquiry</a>
        </div>
    </div>

    <!-- Compact Filters -->
    <div class="prm-top-bar">
        <form method="GET" class="prm-filters">
            <select name="fy" class="form-control">
                <option value="2024-25" {% if filter_fy == '2024-25' %}selected{% endif %}>FY 2024-25</option>
                <option value="2025-26" {% if filter_fy == '2025-26' %}selected{% endif %}>FY 2025-26</option>
                <option value="2026-27" {% if filter_fy == '2026-27' %}selected{% endif %}>FY 2026-27</option>
            </select>
            <select name="office" class="form-control">
                <option value="">All Offices</option>
                {% for off in offices %}
                <option value="{{ off.office_id }}" {% if filter_office == off.office_id %}selected{% endif %}>{{ off.office_name or off.office_id }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary btn-sm">Apply</button>
        </form>
        <div class="prm-conversion-mini">
            <span class="prm-conv-value">{{ "%.1f"|format(metrics.conversion_rate or 0) }}%</span>
            <span class="prm-conv-label">Conversion</span>
        </div>
    </div>

    <!-- Compact Pipeline Stats Row -->
    <div class="prm-stats-row">
        <a href="/enquiry/" class="prm-stat prm-stat-enquiry">
            <div class="prm-stat-num">{{ metrics.total_enquiries or 0 }}</div>
            <div class="prm-stat-name">Enquiries</div>
            <div class="prm-stat-val">₹{{ "%.1f"|format(metrics.enquiry_value or 0) }}L</div>
        </a>
        <div class="prm-arrow">→</div>
        <a href="/proposal-request/" class="prm-stat prm-stat-pr">
            <div class="prm-stat-num">{{ metrics.total_prs or 0 }}</div>
            <div class="prm-stat-name">PRs</div>
            <div class="prm-stat-val">₹{{ "%.1f"|format(metrics.pr_value or 0) }}L</div>
        </a>
        <div class="prm-arrow">→</div>
        <a href="/proposal/" class="prm-stat prm-stat-proposal">
            <div class="prm-stat-num">{{ metrics.total_proposals or 0 }}</div>
            <div class="prm-stat-name">Proposals</div>
            <div class="prm-stat-val">₹{{ "%.1f"|format(metrics.proposal_value or 0) }}L</div>
        </a>
        <div class="prm-arrow">→</div>
        <a href="/assignment/workorders" class="prm-stat prm-stat-wo">
            <div class="prm-stat-num">{{ metrics.work_orders or 0 }}</div>
            <div class="prm-stat-name">Work Orders</div>
            <div class="prm-stat-val">Won</div>
        </a>
    </div>

    <!-- Main Content - Two Column Layout -->
    <div class="prm-main">
        <!-- Left: Funnel Chart -->
        <div class="prm-chart-section">
            <h3>Pipeline Funnel</h3>
            <div class="prm-funnel">
                {% set max_count = [metrics.total_enquiries or 1, metrics.total_prs or 1, metrics.total_proposals or 1, metrics.work_orders or 1]|max %}
                <div class="prm-funnel-stage" style="--width: {{ ((metrics.total_enquiries or 0) / max_count * 100)|round|int }}%;">
                    <div class="prm-funnel-bar prm-funnel-enquiry">
                        <span class="prm-funnel-count">{{ metrics.total_enquiries or 0 }}</span>
                    </div>
                    <span class="prm-funnel-label">Enquiries</span>
                </div>
                <div class="prm-funnel-stage" style="--width: {{ ((metrics.total_prs or 0) / max_count * 100)|round|int }}%;">
                    <div class="prm-funnel-bar prm-funnel-pr">
                        <span class="prm-funnel-count">{{ metrics.total_prs or 0 }}</span>
                    </div>
                    <span class="prm-funnel-label">Proposal Requests</span>
                </div>
                <div class="prm-funnel-stage" style="--width: {{ ((metrics.total_proposals or 0) / max_count * 100)|round|int }}%;">
                    <div class="prm-funnel-bar prm-funnel-proposal">
                        <span class="prm-funnel-count">{{ metrics.total_proposals or 0 }}</span>
                    </div>
                    <span class="prm-funnel-label">Proposals</span>
                </div>
                <div class="prm-funnel-stage" style="--width: {{ ((metrics.work_orders or 0) / max_count * 100)|round|int }}%;">
                    <div class="prm-funnel-bar prm-funnel-wo">
                        <span class="prm-funnel-count">{{ metrics.work_orders or 0 }}</span>
                    </div>
                    <span class="prm-funnel-label">Work Orders</span>
                </div>
            </div>

            <!-- Stage Status Mini Charts -->
            <div class="prm-mini-charts">
                <div class="prm-mini-chart">
                    <div class="prm-mini-title">Enquiry Status</div>
                    <div class="prm-donut-container">
                        {% set enq_total = (metrics.enquiry_open or 0) + (metrics.enquiry_converted or 0) + (metrics.enquiry_dropped or 0) %}
                        {% set enq_open_pct = (metrics.enquiry_open or 0) / (enq_total or 1) * 100 %}
                        {% set enq_conv_pct = (metrics.enquiry_converted or 0) / (enq_total or 1) * 100 %}
                        <svg class="prm-donut" viewBox="0 0 36 36">
                            <circle class="prm-donut-bg" cx="18" cy="18" r="15.9"/>
                            <circle class="prm-donut-seg prm-donut-open" cx="18" cy="18" r="15.9"
                                stroke-dasharray="{{ enq_open_pct }} {{ 100 - enq_open_pct }}"
                                stroke-dashoffset="25"/>
                            <circle class="prm-donut-seg prm-donut-conv" cx="18" cy="18" r="15.9"
                                stroke-dasharray="{{ enq_conv_pct }} {{ 100 - enq_conv_pct }}"
                                stroke-dashoffset="{{ 25 - enq_open_pct }}"/>
                        </svg>
                        <div class="prm-donut-center">{{ enq_total }}</div>
                    </div>
                    <div class="prm-mini-legend">
                        <span class="prm-legend-item"><i style="background:#3b82f6"></i>Open {{ metrics.enquiry_open or 0 }}</span>
                        <span class="prm-legend-item"><i style="background:#22c55e"></i>Conv {{ metrics.enquiry_converted or 0 }}</span>
                    </div>
                </div>
                <div class="prm-mini-chart">
                    <div class="prm-mini-title">PR Status</div>
                    <div class="prm-donut-container">
                        {% set pr_total = (metrics.pr_pending or 0) + (metrics.pr_converted or 0) + (metrics.pr_cancelled or 0) %}
                        {% set pr_pend_pct = (metrics.pr_pending or 0) / (pr_total or 1) * 100 %}
                        {% set pr_conv_pct = (metrics.pr_converted or 0) / (pr_total or 1) * 100 %}
                        <svg class="prm-donut" viewBox="0 0 36 36">
                            <circle class="prm-donut-bg" cx="18" cy="18" r="15.9"/>
                            <circle class="prm-donut-seg prm-donut-pend" cx="18" cy="18" r="15.9"
                                stroke-dasharray="{{ pr_pend_pct }} {{ 100 - pr_pend_pct }}"
                                stroke-dashoffset="25"/>
                            <circle class="prm-donut-seg prm-donut-conv" cx="18" cy="18" r="15.9"
                                stroke-dasharray="{{ pr_conv_pct }} {{ 100 - pr_conv_pct }}"
                                stroke-dashoffset="{{ 25 - pr_pend_pct }}"/>
                        </svg>
                        <div class="prm-donut-center">{{ pr_total }}</div>
                    </div>
                    <div class="prm-mini-legend">
                        <span class="prm-legend-item"><i style="background:#f59e0b"></i>Pend {{ metrics.pr_pending or 0 }}</span>
                        <span class="prm-legend-item"><i style="background:#22c55e"></i>Conv {{ metrics.pr_converted or 0 }}</span>
                    </div>
                </div>
                <div class="prm-mini-chart">
                    <div class="prm-mini-title">Proposal Status</div>
                    <div class="prm-donut-container">
                        {% set prop_total = (metrics.proposal_submitted or 0) + (metrics.proposal_won or 0) + (metrics.proposal_lost or 0) %}
                        {% set prop_sub_pct = (metrics.proposal_submitted or 0) / (prop_total or 1) * 100 %}
                        {% set prop_won_pct = (metrics.proposal_won or 0) / (prop_total or 1) * 100 %}
                        <svg class="prm-donut" viewBox="0 0 36 36">
                            <circle class="prm-donut-bg" cx="18" cy="18" r="15.9"/>
                            <circle class="prm-donut-seg prm-donut-pend" cx="18" cy="18" r="15.9"
                                stroke-dasharray="{{ prop_sub_pct }} {{ 100 - prop_sub_pct }}"
                                stroke-dashoffset="25"/>
                            <circle class="prm-donut-seg prm-donut-conv" cx="18" cy="18" r="15.9"
                                stroke-dasharray="{{ prop_won_pct }} {{ 100 - prop_won_pct }}"
                                stroke-dashoffset="{{ 25 - prop_sub_pct }}"/>
                        </svg>
                        <div class="prm-donut-center">{{ prop_total }}</div>
                    </div>
                    <div class="prm-mini-legend">
                        <span class="prm-legend-item"><i style="background:#f59e0b"></i>Sub {{ metrics.proposal_submitted or 0 }}</span>
                        <span class="prm-legend-item"><i style="background:#22c55e"></i>Won {{ metrics.proposal_won or 0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Pipeline Table -->
        <div class="prm-table-section">
            <div class="prm-table-header">
                <h3>Pipeline Value Breakdown</h3>
                <div class="prm-total-badge">
                    Total: <strong>₹{{ "%.2f"|format(metrics.total_pipeline_value or 0) }}L</strong>
                </div>
            </div>
            <table class="compact-table">
                <thead>
                    <tr>
                        <th>Stage</th>
                        <th style="text-align:center">Open</th>
                        <th style="text-align:center">Converted</th>
                        <th style="text-align:right">Value (₹L)</th>
                        <th style="width:100px">Progress</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="prm-badge prm-badge-enq">Enquiries</span></td>
                        <td style="text-align:center;font-weight:600">{{ metrics.enquiry_open or 0 }}</td>
                        <td style="text-align:center;color:#22c55e">{{ metrics.enquiry_converted or 0 }}</td>
                        <td style="text-align:right;font-weight:600">{{ "%.2f"|format(metrics.enquiry_value or 0) }}</td>
                        <td>
                            <div class="prm-bar">
                                <div class="prm-bar-fill prm-bar-enq" style="width:{{ ((metrics.enquiry_value or 0) / (metrics.total_pipeline_value or 1) * 100)|round|int }}%"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><span class="prm-badge prm-badge-pr">Proposal Requests</span></td>
                        <td style="text-align:center;font-weight:600">{{ metrics.pr_pending or 0 }}</td>
                        <td style="text-align:center;color:#22c55e">{{ metrics.pr_converted or 0 }}</td>
                        <td style="text-align:right;font-weight:600">{{ "%.2f"|format(metrics.pr_value or 0) }}</td>
                        <td>
                            <div class="prm-bar">
                                <div class="prm-bar-fill prm-bar-pr" style="width:{{ ((metrics.pr_value or 0) / (metrics.total_pipeline_value or 1) * 100)|round|int }}%"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><span class="prm-badge prm-badge-prop">Proposals</span></td>
                        <td style="text-align:center;font-weight:600">{{ metrics.proposal_submitted or 0 }}</td>
                        <td style="text-align:center;color:#22c55e">{{ metrics.proposal_won or 0 }}</td>
                        <td style="text-align:right;font-weight:600">{{ "%.2f"|format(metrics.proposal_value or 0) }}</td>
                        <td>
                            <div class="prm-bar">
                                <div class="prm-bar-fill prm-bar-prop" style="width:{{ ((metrics.proposal_value or 0) / (metrics.total_pipeline_value or 1) * 100)|round|int }}%"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr style="background:#f0fdf4">
                        <td><strong>Total Pipeline</strong></td>
                        <td style="text-align:center;font-weight:600">{{ (metrics.enquiry_open or 0) + (metrics.pr_pending or 0) + (metrics.proposal_submitted or 0) }}</td>
                        <td style="text-align:center;color:#22c55e;font-weight:600">{{ (metrics.enquiry_converted or 0) + (metrics.pr_converted or 0) + (metrics.proposal_won or 0) }}</td>
                        <td style="text-align:right;font-weight:700;color:#059669">{{ "%.2f"|format(metrics.total_pipeline_value or 0) }}</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <!-- Conversion Rates -->
            <div class="prm-conv-rates">
                <div class="prm-conv-item">
                    <div class="prm-conv-rate">
                        {% set enq_conv = ((metrics.enquiry_converted or 0) / ((metrics.enquiry_open or 0) + (metrics.enquiry_converted or 0) + (metrics.enquiry_dropped or 0) or 1) * 100) %}
                        {{ "%.0f"|format(enq_conv) }}%
                    </div>
                    <div class="prm-conv-desc">Enquiry → PR</div>
                </div>
                <div class="prm-conv-item">
                    <div class="prm-conv-rate">
                        {% set pr_conv = ((metrics.pr_converted or 0) / ((metrics.pr_pending or 0) + (metrics.pr_converted or 0) + (metrics.pr_cancelled or 0) or 1) * 100) %}
                        {{ "%.0f"|format(pr_conv) }}%
                    </div>
                    <div class="prm-conv-desc">PR → Proposal</div>
                </div>
                <div class="prm-conv-item">
                    <div class="prm-conv-rate">
                        {% set prop_conv = ((metrics.proposal_won or 0) / ((metrics.proposal_submitted or 0) + (metrics.proposal_won or 0) + (metrics.proposal_lost or 0) or 1) * 100) %}
                        {{ "%.0f"|format(prop_conv) }}%
                    </div>
                    <div class="prm-conv-desc">Proposal → Won</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Compact Top Bar */
.prm-top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    gap: 16px;
    flex-wrap: wrap;
}

.prm-filters {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.prm-filters .form-control {
    padding: 8px 12px;
    font-size: 0.8125rem;
    min-width: 100px;
}

.prm-conversion-mini {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    border-radius: 8px;
    color: white;
}

.prm-conv-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.prm-conv-label {
    font-size: 0.75rem;
    opacity: 0.9;
}

/* Compact Stats Row */
.prm-stats-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px;
    background: white;
    border-bottom: 1px solid #e2e8f0;
    overflow-x: auto;
}

.prm-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 20px;
    border-radius: 10px;
    text-decoration: none;
    color: white;
    min-width: 90px;
    transition: transform 0.2s;
}

.prm-stat:hover {
    transform: scale(1.05);
}

.prm-stat-enquiry { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.prm-stat-pr { background: linear-gradient(135deg, #06b6d4, #0284c7); }
.prm-stat-proposal { background: linear-gradient(135deg, #f59e0b, #d97706); }
.prm-stat-wo { background: linear-gradient(135deg, #10b981, #059669); }

.prm-stat-num {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
}

.prm-stat-name {
    font-size: 0.6875rem;
    opacity: 0.9;
    margin-top: 2px;
}

.prm-stat-val {
    font-size: 0.6875rem;
    opacity: 0.8;
    margin-top: 4px;
}

.prm-arrow {
    color: #94a3b8;
    font-size: 1.25rem;
    font-weight: 300;
}

/* Main Two-Column Layout */
.prm-main {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 20px;
    padding: 16px;
    min-height: 0;
}

/* Chart Section */
.prm-chart-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
}

.prm-chart-section h3 {
    font-size: 0.9375rem;
    margin: 0 0 16px;
    color: #1e293b;
}

/* Funnel Chart */
.prm-funnel {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
}

.prm-funnel-stage {
    display: flex;
    align-items: center;
    gap: 10px;
}

.prm-funnel-bar {
    height: 28px;
    min-width: 40px;
    width: max(var(--width), 40px);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.8125rem;
    transition: width 0.3s;
}

.prm-funnel-enquiry { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.prm-funnel-pr { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
.prm-funnel-proposal { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
.prm-funnel-wo { background: linear-gradient(90deg, #10b981, #34d399); }

.prm-funnel-label {
    font-size: 0.75rem;
    color: #64748b;
    white-space: nowrap;
}

/* Mini Charts */
.prm-mini-charts {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.prm-mini-chart {
    text-align: center;
}

.prm-mini-title {
    font-size: 0.6875rem;
    color: #64748b;
    margin-bottom: 8px;
}

.prm-donut-container {
    position: relative;
    width: 60px;
    height: 60px;
    margin: 0 auto;
}

.prm-donut {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.prm-donut-bg {
    fill: none;
    stroke: #e2e8f0;
    stroke-width: 3;
}

.prm-donut-seg {
    fill: none;
    stroke-width: 3;
    stroke-linecap: round;
}

.prm-donut-open { stroke: #3b82f6; }
.prm-donut-pend { stroke: #f59e0b; }
.prm-donut-conv { stroke: #22c55e; }

.prm-donut-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.875rem;
    font-weight: 700;
    color: #1e293b;
}

.prm-mini-legend {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-top: 6px;
}

.prm-legend-item {
    font-size: 0.625rem;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.prm-legend-item i {
    width: 8px;
    height: 8px;
    border-radius: 2px;
    display: inline-block;
}

/* Table Section */
.prm-table-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    display: flex;
    flex-direction: column;
}

.prm-table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.prm-table-header h3 {
    font-size: 0.9375rem;
    margin: 0;
    color: #1e293b;
}

.prm-total-badge {
    background: #f0fdf4;
    color: #166534;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8125rem;
}

.prm-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.prm-badge-enq { background: #dbeafe; color: #1e40af; }
.prm-badge-pr { background: #e0f2fe; color: #0369a1; }
.prm-badge-prop { background: #fef3c7; color: #b45309; }

.prm-bar {
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
}

.prm-bar-fill {
    height: 100%;
    border-radius: 3px;
}

.prm-bar-enq { background: #3b82f6; }
.prm-bar-pr { background: #06b6d4; }
.prm-bar-prop { background: #f59e0b; }

/* Conversion Rates */
.prm-conv-rates {
    display: flex;
    justify-content: space-around;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e2e8f0;
}

.prm-conv-item {
    text-align: center;
}

.prm-conv-rate {
    font-size: 1.25rem;
    font-weight: 700;
    color: #7c3aed;
}

.prm-conv-desc {
    font-size: 0.6875rem;
    color: #64748b;
    margin-top: 2px;
}

/* Responsive */
@media (max-width: 900px) {
    .prm-main {
        grid-template-columns: 1fr;
    }

    .prm-chart-section {
        order: 2;
    }

    .prm-mini-charts {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .prm-top-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }

    .prm-filters {
        width: 100%;
    }

    .prm-filters .form-control {
        flex: 1;
        min-width: 0;
    }

    .prm-conversion-mini {
        justify-content: center;
    }

    .prm-stats-row {
        padding: 12px 8px;
        gap: 4px;
    }

    .prm-stat {
        padding: 10px 12px;
        min-width: 70px;
    }

    .prm-stat-num {
        font-size: 1.25rem;
    }

    .prm-stat-name {
        font-size: 0.625rem;
    }

    .prm-arrow {
        font-size: 1rem;
    }

    .prm-main {
        padding: 12px;
        gap: 12px;
    }

    .prm-chart-section,
    .prm-table-section {
        padding: 12px;
    }

    .prm-funnel-bar {
        height: 24px;
        font-size: 0.75rem;
    }

    .prm-mini-charts {
        gap: 8px;
    }

    .prm-donut-container {
        width: 50px;
        height: 50px;
    }

    .prm-conv-rates {
        flex-wrap: wrap;
        gap: 12px;
    }

    .prm-conv-item {
        flex: 1;
        min-width: 80px;
    }
}

@media (max-width: 480px) {
    .prm-stats-row {
        flex-wrap: wrap;
        justify-content: center;
    }

    .prm-arrow {
        display: none;
    }

    .prm-stat {
        flex: 1;
        min-width: calc(50% - 8px);
        max-width: calc(50% - 8px);
    }

    .prm-funnel-label {
        font-size: 0.625rem;
    }

    .prm-table-header {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
    }

    .compact-table {
        font-size: 0.6875rem;
    }

    .compact-table th,
    .compact-table td {
        padding: 6px 8px;
    }
}
</style>
{% endblock %}
