{% extends "base.html" %}

{% block title %}MIS Analytics - PMS Portal{% endblock %}

{% block content %}
<div class="tab-container">
    <!-- Header -->
    <div class="tab-header">
        <h1>MIS / Analytics</h1>
        <div class="tab-actions">
            <a href="/mis/pre-revenue" class="btn btn-info btn-sm">Pre-Revenue</a>
            <a href="/mis/assignments" class="btn btn-secondary btn-sm">All Assignments</a>
            {% if fy_progress %}
            <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f1f5f9; border-radius: 6px;">
                <span style="font-size: 0.75rem; color: #64748b;">FY {{ financial_year or 'Current' }}:</span>
                <div style="width: 60px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                    <div style="width: {{ (fy_progress * 100)|round|int }}%; height: 100%; background: #3b82f6;"></div>
                </div>
                <span style="font-size: 0.75rem; font-weight: 600; color: #3b82f6;">{{ (fy_progress * 100)|round|int }}%</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="stats-row" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
        <div class="stat-mini" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 16px; border-radius: 10px; text-align: center; color: white;">
            <div style="font-size: 1.5rem; font-weight: 700;">{{ "%.1f"|format(totals.total_target or 0) }}L</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">Annual Target</div>
        </div>
        <div class="stat-mini" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #f59e0b, #d97706); padding: 16px; border-radius: 10px; text-align: center; color: white;">
            <div style="font-size: 1.5rem; font-weight: 700;">{{ "%.1f"|format(totals.prorata_target or 0) }}L</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">Pro-rata Target</div>
        </div>
        <div class="stat-mini" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #10b981, #059669); padding: 16px; border-radius: 10px; text-align: center; color: white;">
            <div style="font-size: 1.5rem; font-weight: 700;">{{ "%.1f"|format(totals.total_revenue or 0) }}L</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">Total Revenue</div>
        </div>
        <div class="stat-mini" style="flex: 1; min-width: 150px; background: {% if (totals.total_revenue or 0) >= (totals.prorata_target or 1) %}linear-gradient(135deg, #10b981, #059669){% else %}linear-gradient(135deg, #ef4444, #dc2626){% endif %}; padding: 16px; border-radius: 10px; text-align: center; color: white;">
            <div style="font-size: 1.5rem; font-weight: 700;">{{ "%.1f"|format(totals.achievement_pct or 0) }}%</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">Achievement</div>
        </div>
    </div>

    <!-- Secondary Stats -->
    <div class="stats-row" style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
        <div class="stat-mini" style="flex: 1; min-width: 120px; background: #f8fafc; padding: 14px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.25rem; font-weight: 600; color: #1e293b;">{{ totals.total_assignments }}</div>
            <div style="font-size: 0.75rem; color: #64748b;">Assignments</div>
        </div>
        <div class="stat-mini" style="flex: 1; min-width: 120px; background: #f8fafc; padding: 14px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.25rem; font-weight: 600; color: #1e293b;">{{ "%.1f"|format(totals.total_expenditure or 0) }}L</div>
            <div style="font-size: 0.75rem; color: #64748b;">Expenditure</div>
        </div>
        <div class="stat-mini" style="flex: 1; min-width: 120px; background: #f8fafc; padding: 14px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.25rem; font-weight: 600; color: {% if (totals.surplus_deficit or 0) >= 0 %}#10b981{% else %}#ef4444{% endif %};">{{ "%.1f"|format(totals.surplus_deficit or 0) }}L</div>
            <div style="font-size: 0.75rem; color: #64748b;">Surplus/Deficit</div>
        </div>
        <div class="stat-mini" style="flex: 1; min-width: 120px; background: #f8fafc; padding: 14px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.25rem; font-weight: 600; color: #3b82f6;">{{ "%.0f"|format(totals.avg_physical_progress or 0) }}%</div>
            <div style="font-size: 0.75rem; color: #64748b;">Avg Progress</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <form method="GET" action="/mis" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; width: 100%;">
            <select name="financial_year" class="form-control" style="width: auto; min-width: 100px;">
                <option value="">All FY</option>
                {% for fy in financial_years %}
                <option value="{{ fy }}" {% if financial_year == fy %}selected{% endif %}>{{ fy }}</option>
                {% endfor %}
            </select>
            <select name="filter_office" class="form-control" style="width: auto; min-width: 120px;">
                <option value="">All Offices</option>
                {% for office in offices %}
                <option value="{{ office.office_id }}" {% if filter_office == office.office_id %}selected{% endif %}>{{ office.office_id }}</option>
                {% endfor %}
            </select>
            <select name="filter_domain" class="form-control" style="width: auto; min-width: 120px;">
                <option value="">All Domains</option>
                {% for domain in domains %}
                <option value="{{ domain }}" {% if filter_domain == domain %}selected{% endif %}>{{ domain }}</option>
                {% endfor %}
            </select>
            <input type="date" name="date_from" value="{{ date_from or '' }}" class="form-control" style="width: auto;" placeholder="From">
            <input type="date" name="date_to" value="{{ date_to or '' }}" class="form-control" style="width: auto;" placeholder="To">
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
            <a href="/mis" class="btn btn-secondary btn-sm">Reset</a>
        </form>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab-btn="mis" onclick="switchTab('tab-office', 'mis')">
            Office-wise
        </button>
        <button class="tab-btn" data-tab-btn="mis" onclick="switchTab('tab-status', 'mis')">
            Status
        </button>
        <button class="tab-btn" data-tab-btn="mis" onclick="switchTab('tab-domain', 'mis')">
            Domain-wise
        </button>
        <button class="tab-btn" data-tab-btn="mis" onclick="switchTab('tab-officer', 'mis')">
            Officer-wise
        </button>
    </div>

    <!-- Tab Content: Office-wise -->
    <div id="tab-office" class="tab-content active" data-tab-group="mis">
        {% if office_data %}
        <table class="compact-table">
            <thead>
                <tr>
                    <th>Office</th>
                    <th style="text-align: right;">Officers</th>
                    <th style="text-align: right;">Target</th>
                    <th style="text-align: right;">Pro-rata</th>
                    <th style="text-align: right;">Revenue</th>
                    <th style="text-align: right;">Achievement</th>
                    <th style="text-align: right;">Surplus/Deficit</th>
                    <th style="text-align: right;">Progress</th>
                </tr>
            </thead>
            <tbody>
                {% for office in office_data %}
                <tr>
                    <td>
                        <a href="/mis/office/{{ office.office_id }}" class="link-primary">
                            <strong>{{ office.office_id }}</strong>
                        </a>
                        {% if office.is_top %}<span class="badge badge-success" style="font-size: 0.625rem; margin-left: 4px;">Top</span>{% endif %}
                        {% if office.is_bottom %}<span class="badge badge-danger" style="font-size: 0.625rem; margin-left: 4px;">Low</span>{% endif %}
                    </td>
                    <td style="text-align: right;">{{ office.officer_count or 0 }}</td>
                    <td style="text-align: right;">{{ "%.1f"|format(office.target or office.annual_revenue_target or 0) }}L</td>
                    <td style="text-align: right;">{{ "%.1f"|format(office.prorata_target or 0) }}L</td>
                    <td style="text-align: right; font-weight: 600;">{{ "%.1f"|format(office.total_revenue or 0) }}L</td>
                    <td style="text-align: right;">
                        <span class="{% if (office.achievement_pct or 0) >= 100 %}text-success{% elif (office.achievement_pct or 0) >= 75 %}text-warning{% else %}text-danger{% endif %}" style="font-weight: 600;">
                            {{ "%.0f"|format(office.achievement_pct or 0) }}%
                        </span>
                    </td>
                    <td style="text-align: right;">
                        <span class="{% if (office.surplus_deficit or 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.1f"|format(office.surplus_deficit or 0) }}L
                        </span>
                    </td>
                    <td style="text-align: right;">
                        <div style="display: inline-flex; align-items: center; gap: 6px;">
                            <div style="width: 50px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                                <div style="width: {{ (office.avg_physical_progress or 0)|round|int }}%; height: 100%; background: #3b82f6;"></div>
                            </div>
                            <span style="font-size: 0.75rem;">{{ "%.0f"|format(office.avg_physical_progress or 0) }}%</span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="background: #f8fafc; font-weight: 600;">
                    <td>TOTAL</td>
                    <td style="text-align: right;">{{ totals.total_officers or 0 }}</td>
                    <td style="text-align: right;">{{ "%.1f"|format(totals.total_target or 0) }}L</td>
                    <td style="text-align: right;">{{ "%.1f"|format(totals.prorata_target or 0) }}L</td>
                    <td style="text-align: right;">{{ "%.1f"|format(totals.total_revenue or 0) }}L</td>
                    <td style="text-align: right;">{{ "%.0f"|format(totals.achievement_pct or 0) }}%</td>
                    <td style="text-align: right;">{{ "%.1f"|format(totals.surplus_deficit or 0) }}L</td>
                    <td style="text-align: right;">{{ "%.0f"|format(totals.avg_physical_progress or 0) }}%</td>
                </tr>
            </tfoot>
        </table>
        {% else %}
        <div class="empty-state" style="padding: 40px; text-align: center;">
            <h3>No office data available</h3>
            <p>Apply different filters or add assignments to see office-wise data.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab Content: Status Overview -->
    <div id="tab-status" class="tab-content" data-tab-group="mis">
        {% if progress_by_status %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
            {% for status in progress_by_status %}
            <div style="padding: 20px; border-radius: 10px; text-align: center;
                {% if status.status == 'Completed' %}background: linear-gradient(135deg, #dcfce7, #bbf7d0);
                {% elif status.status == 'In Progress' %}background: linear-gradient(135deg, #dbeafe, #bfdbfe);
                {% elif status.status == 'On Hold' %}background: linear-gradient(135deg, #fef3c7, #fde68a);
                {% elif status.status == 'Pipeline' %}background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
                {% else %}background: #f8fafc;{% endif %}">
                <div style="font-size: 1.75rem; font-weight: 700;
                    {% if status.status == 'Completed' %}color: #16a34a;
                    {% elif status.status == 'In Progress' %}color: #2563eb;
                    {% elif status.status == 'On Hold' %}color: #d97706;
                    {% elif status.status == 'Pipeline' %}color: #7c3aed;
                    {% else %}color: #64748b;{% endif %}">
                    {{ status.count }}
                </div>
                <div style="font-size: 0.8125rem; font-weight: 500; color: #475569; margin-bottom: 8px;">{{ status.status }}</div>
                <div style="font-size: 0.75rem; color: #64748b;">
                    Avg: {{ "%.0f"|format(status.avg_progress or 0) }}%
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state" style="padding: 40px; text-align: center;">
            <h3>No status data available</h3>
        </div>
        {% endif %}
    </div>

    <!-- Tab Content: Domain-wise -->
    <div id="tab-domain" class="tab-content" data-tab-group="mis">
        {% if domain_data %}
        {% set max_domain_revenue = domain_data|map(attribute='total_revenue')|max or 1 %}
        <table class="compact-table">
            <thead>
                <tr>
                    <th>Domain</th>
                    <th style="text-align: right;">Assignments</th>
                    <th style="text-align: right;">Revenue</th>
                    <th style="text-align: right;">Expenditure</th>
                    <th style="text-align: right;">Surplus/Deficit</th>
                    <th style="width: 150px;">Chart</th>
                </tr>
            </thead>
            <tbody>
                {% for domain in domain_data %}
                <tr>
                    <td><strong>{{ domain.domain }}</strong></td>
                    <td style="text-align: right;">{{ domain.assignment_count }}</td>
                    <td style="text-align: right; font-weight: 600;">{{ "%.1f"|format(domain.total_revenue or 0) }}L</td>
                    <td style="text-align: right;">{{ "%.1f"|format(domain.total_expenditure or 0) }}L</td>
                    <td style="text-align: right;">
                        <span class="{% if (domain.surplus_deficit or 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.1f"|format(domain.surplus_deficit or 0) }}L
                        </span>
                    </td>
                    <td>
                        <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ ((domain.total_revenue or 0) / max_domain_revenue * 100)|round|int }}%; height: 100%; background: linear-gradient(90deg, #3b82f6, #1d4ed8);"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state" style="padding: 40px; text-align: center;">
            <h3>No domain data available</h3>
        </div>
        {% endif %}
    </div>

    <!-- Tab Content: Officer-wise -->
    <div id="tab-officer" class="tab-content" data-tab-group="mis">
        {% if officer_data %}
        <p style="color: #64748b; font-size: 0.8125rem; margin-bottom: 12px;">
            Showing {{ officer_data|length }} officers with revenue shares
        </p>
        <table class="compact-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Officer</th>
                    <th>Office</th>
                    <th style="text-align: right;">Target</th>
                    <th style="text-align: right;">Pro-rata</th>
                    <th style="text-align: right;">Share</th>
                    <th style="text-align: right;">Achievement</th>
                    <th style="text-align: right;">Assignments</th>
                </tr>
            </thead>
            <tbody>
                {% for officer in officer_data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        <a href="/mis/officer/{{ officer.officer_id }}" class="link-primary">
                            <strong>{{ officer.name }}</strong>
                        </a>
                        {% if officer.is_top and loop.index <= 10 %}<span class="badge badge-success" style="font-size: 0.625rem; margin-left: 4px;">Top 10</span>{% endif %}
                        {% if officer.is_bottom %}<span class="badge badge-danger" style="font-size: 0.625rem; margin-left: 4px;">Low</span>{% endif %}
                    </td>
                    <td>{{ officer.office_id }}</td>
                    <td style="text-align: right;">{{ "%.1f"|format(officer.annual_target or 60) }}L</td>
                    <td style="text-align: right;">{{ "%.1f"|format(officer.prorata_target or 0) }}L</td>
                    <td style="text-align: right; font-weight: 600;">{{ "%.1f"|format(officer.total_share_amount or 0) }}L</td>
                    <td style="text-align: right;">
                        <span class="{% if (officer.achievement_pct or 0) >= 100 %}text-success{% elif (officer.achievement_pct or 0) >= 75 %}text-warning{% else %}text-danger{% endif %}" style="font-weight: 600;">
                            {{ "%.0f"|format(officer.achievement_pct or 0) }}%
                        </span>
                    </td>
                    <td style="text-align: right;">{{ officer.assignment_count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state" style="padding: 40px; text-align: center;">
            <h3>No revenue shares allocated yet</h3>
            <p>Officer data will appear once revenue shares are allocated to assignments.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
