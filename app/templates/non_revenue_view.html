{% extends "base.html" %}

{% block title %}{{ suggestion.suggestion_number }} - Non-Revenue - PMS Portal{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="breadcrumb">
            <a href="/non-revenue/">Non-Revenue</a>
            <span>/</span>
            <span>{{ suggestion.suggestion_number }}</span>
        </div>
        <h1>{{ suggestion.title }}</h1>
        <div class="header-badges">
            <span class="badge badge-purple">{{ activity_types.get(suggestion.activity_type, 'Other') }}</span>
            <span class="badge
                {% if suggestion.status == 'PENDING_APPROVAL' %}badge-warning
                {% elif suggestion.status == 'IN_PROGRESS' %}badge-info
                {% elif suggestion.status == 'COMPLETED' %}badge-success
                {% elif suggestion.status == 'REJECTED' %}badge-danger
                {% else %}badge-secondary{% endif %}">
                {{ suggestion.status|replace('_', ' ') }}
            </span>
            {% if suggestion.approval_status == 'PENDING' %}
            <span class="badge badge-warning">Awaiting Approval</span>
            {% elif suggestion.approval_status == 'APPROVED' %}
            <span class="badge badge-success">Approved</span>
            {% elif suggestion.approval_status == 'REJECTED' %}
            <span class="badge badge-danger">Rejected</span>
            {% endif %}
        </div>
    </div>
    <div class="page-actions">
        <a href="/non-revenue/" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ suggestion.office_id }}</div>
            <div class="stat-label">Office</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">Rs. {{ "%.2f"|format(suggestion.notional_value or 0) }} L</div>
            <div class="stat-label">Notional Value</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ suggestion.target_start_date or 'TBD' }}</div>
            <div class="stat-label">Target Start</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ suggestion.target_end_date or 'TBD' }}</div>
            <div class="stat-label">Target End</div>
        </div>
    </div>
</div>

<div class="detail-grid">
    <!-- Main Details -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Suggestion Details</h2>
        </div>
        <div class="card-body">
            <div class="detail-row">
                <span class="detail-label">Suggestion Number</span>
                <span class="detail-value">{{ suggestion.suggestion_number }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Activity Type</span>
                <span class="detail-value">{{ activity_types.get(suggestion.activity_type, 'Other') }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Office</span>
                <span class="detail-value">{{ suggestion.office_id }} - {{ suggestion.office_name }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Beneficiary</span>
                <span class="detail-value">{{ suggestion.beneficiary or '-' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Created By</span>
                <span class="detail-value">{{ suggestion.created_by_name or '-' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Allocated To</span>
                <span class="detail-value">{{ suggestion.officer_name or 'Not allocated' }}</span>
            </div>
            {% if suggestion.description %}
            <div class="detail-row full-width">
                <span class="detail-label">Description</span>
                <span class="detail-value">{{ suggestion.description }}</span>
            </div>
            {% endif %}
            {% if suggestion.justification %}
            <div class="detail-row full-width">
                <span class="detail-label">Justification</span>
                <span class="detail-value">{{ suggestion.justification }}</span>
            </div>
            {% endif %}
            {% if suggestion.expected_outcome %}
            <div class="detail-row full-width">
                <span class="detail-label">Expected Outcome</span>
                <span class="detail-value">{{ suggestion.expected_outcome }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Actions Panel -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Actions</h2>
        </div>
        <div class="card-body">
            <!-- Approval Section (for Heads) -->
            {% if is_head and suggestion.approval_status == 'PENDING' %}
            <div class="action-section">
                <h4>Approve/Reject Suggestion</h4>
                <form method="POST" action="/non-revenue/approve/{{ suggestion.id }}" class="action-form">
                    <div class="form-group">
                        <label for="officer_id">Allocate to Officer</label>
                        <select name="officer_id" id="officer_id" class="form-control">
                            <option value="">Select Officer (Optional)</option>
                            {% for officer in officers %}
                            <option value="{{ officer.officer_id }}">{{ officer.name }} ({{ officer.office_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">Approve Suggestion</button>
                </form>

                <div class="divider">or</div>

                <form method="POST" action="/non-revenue/reject/{{ suggestion.id }}" class="action-form">
                    <div class="form-group">
                        <label for="rejection_reason">Rejection Reason *</label>
                        <textarea name="rejection_reason" id="rejection_reason" class="form-control" rows="2" required
                                  placeholder="Please provide a reason for rejection"></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger btn-block">Reject Suggestion</button>
                </form>
            </div>
            {% endif %}

            <!-- Progress Update (for allocated officer) -->
            {% if suggestion.officer_id == user.officer_id and suggestion.status == 'IN_PROGRESS' %}
            <div class="action-section">
                <h4>Update Progress</h4>
                <form method="POST" action="/non-revenue/update/{{ suggestion.id }}" class="action-form">
                    <div class="form-group">
                        <label for="current_update">Progress Update *</label>
                        <textarea name="current_update" id="current_update" class="form-control" rows="3" required
                                  placeholder="Describe the current progress">{{ suggestion.current_update or '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select name="status" id="status" class="form-control">
                            <option value="">No Change</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="ON_HOLD">On Hold</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Save Update</button>
                </form>

                <form method="POST" action="/non-revenue/complete/{{ suggestion.id }}" class="action-form" style="margin-top: 15px;">
                    <button type="submit" class="btn btn-success btn-block">Mark as Completed</button>
                </form>
            </div>
            {% endif %}

            <!-- Current Progress -->
            {% if suggestion.current_update %}
            <div class="action-section">
                <h4>Current Progress</h4>
                <div class="progress-note">
                    {{ suggestion.current_update }}
                </div>
            </div>
            {% endif %}

            <!-- Rejection Info -->
            {% if suggestion.rejection_reason %}
            <div class="action-section alert-section">
                <h4>Rejection Reason</h4>
                <div class="alert alert-error">
                    {{ suggestion.rejection_reason }}
                </div>
            </div>
            {% endif %}

            <!-- Status Info -->
            <div class="action-section">
                <h4>Status History</h4>
                <div class="status-info">
                    <div class="status-row">
                        <span>Created:</span>
                        <span>{{ suggestion.created_at[:10] if suggestion.created_at else '-' }} by {{ suggestion.created_by_name or 'Unknown' }}</span>
                    </div>
                    {% if suggestion.approved_by_name %}
                    <div class="status-row">
                        <span>{{ 'Approved' if suggestion.approval_status == 'APPROVED' else 'Rejected' }}:</span>
                        <span>{{ suggestion.approved_at[:10] if suggestion.approved_at else '-' }} by {{ suggestion.approved_by_name }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
