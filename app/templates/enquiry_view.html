{% extends "base.html" %}

{% block title %}Enquiry {{ enquiry.enquiry_number }} - PMS Portal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header with Actions -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="mb-1">{{ enquiry.enquiry_number }}</h3>
                    <span class="badge
                        {% if enquiry.status == 'PENDING_APPROVAL' %}bg-warning text-dark
                        {% elif enquiry.status == 'APPROVED' %}bg-info
                        {% elif enquiry.status == 'IN_PROGRESS' %}bg-primary
                        {% elif enquiry.status == 'CONVERTED_TO_PR' %}bg-success
                        {% elif enquiry.status == 'ON_HOLD' %}bg-secondary
                        {% elif enquiry.status == 'REJECTED' %}bg-danger
                        {% else %}bg-dark{% endif %}">
                        {{ enquiry.status|replace('_', ' ') }}
                    </span>
                </div>
                <div>
                    <a href="/enquiry/" class="btn btn-outline-secondary">Back to List</a>
                </div>
            </div>

            <!-- Pending Approval Alert for Heads -->
            {% if enquiry.status == 'PENDING_APPROVAL' and is_head %}
            <div class="alert alert-warning">
                <h5>Action Required: Approve or Reject this Enquiry</h5>
                <p>This enquiry was created by {{ enquiry.created_by_name }} and is pending your approval.</p>
                <div class="row">
                    <div class="col-md-6">
                        <form method="POST" action="/enquiry/{{ enquiry.id }}/approve">
                            <div class="mb-3">
                                <label class="form-label">Allocate to Officer <span class="text-danger">*</span></label>
                                <select name="officer_id" class="form-select" required>
                                    <option value="">Select Officer</option>
                                    {% for o in officers %}
                                    <option value="{{ o.officer_id }}"
                                            {% if enquiry.created_by == o.officer_id %}selected{% endif %}>
                                        {{ o.name }} ({{ o.office_id }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Approve & Allocate</button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <form method="POST" action="/enquiry/{{ enquiry.id }}/reject">
                            <div class="mb-3">
                                <label class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                                <textarea name="rejection_reason" class="form-control" rows="2" required
                                          placeholder="Reason for rejection..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-danger">Reject</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Rejection Notice -->
            {% if enquiry.status == 'REJECTED' %}
            <div class="alert alert-danger">
                <strong>Rejected by {{ enquiry.approved_by_name }}</strong><br>
                Reason: {{ enquiry.rejection_reason }}
            </div>
            {% endif %}

            <div class="row">
                <!-- Main Details Card -->
                <div class="col-md-8">
                    <!-- Action Buttons -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2">
                                {% if can_edit and enquiry.status not in ['CONVERTED_TO_PR', 'DROPPED', 'REJECTED'] %}
                                <a href="/enquiry/{{ enquiry.id }}/edit" class="btn btn-outline-primary">Edit Details</a>
                                {% endif %}

                                {% if (is_allocated_officer or is_head) and enquiry.status in ['APPROVED', 'IN_PROGRESS'] %}
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#progressModal">
                                    Update Progress
                                </button>
                                <form method="POST" action="/enquiry/{{ enquiry.id }}/convert-to-pr" class="d-inline">
                                    <button type="submit" class="btn btn-success"
                                            onclick="return confirm('Convert this enquiry to Proposal Request?')">
                                        Convert to PR
                                    </button>
                                </form>
                                {% endif %}

                                {% if (is_allocated_officer or is_head) and enquiry.status in ['APPROVED', 'IN_PROGRESS'] %}
                                <form method="POST" action="/enquiry/{{ enquiry.id }}/hold" class="d-inline">
                                    <button type="submit" class="btn btn-outline-secondary">Put on Hold</button>
                                </form>
                                {% endif %}

                                {% if enquiry.status == 'ON_HOLD' and (is_allocated_officer or is_head) %}
                                <form method="POST" action="/enquiry/{{ enquiry.id }}/resume" class="d-inline">
                                    <button type="submit" class="btn btn-info">Resume</button>
                                </form>
                                {% endif %}

                                {% if is_head and enquiry.status not in ['CONVERTED_TO_PR', 'DROPPED', 'REJECTED'] %}
                                <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#reallocateModal">
                                    Reallocate Officer
                                </button>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#dropModal">
                                    Drop
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Enquiry Details</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <th style="width: 30%">Client Name</th>
                                    <td>{{ enquiry.client_name }}</td>
                                </tr>
                                <tr>
                                    <th>Client Type</th>
                                    <td>{{ enquiry.client_type or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Domain</th>
                                    <td>{{ enquiry.domain or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Sub-Domain</th>
                                    <td>{{ enquiry.sub_domain or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Description / Scope</th>
                                    <td>{{ enquiry.description or '-' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Current Progress Update -->
                    {% if enquiry.current_update %}
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Latest Progress Update</h5>
                        </div>
                        <div class="card-body">
                            <p>{{ enquiry.current_update }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Financial & Timeline -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Financial & Timeline</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1 text-muted">Estimated Value</p>
                                    <h4>
                                        {% if enquiry.estimated_value %}
                                        Rs. {{ "%.2f"|format(enquiry.estimated_value) }} L
                                        {% else %}
                                        <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </h4>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1 text-muted">Target Date</p>
                                    <h4>
                                        {% if enquiry.target_date %}
                                        {{ enquiry.target_date }}
                                        {% else %}
                                        <span class="text-muted">Not set</span>
                                        {% endif %}
                                    </h4>
                                </div>
                            </div>
                            {% if enquiry.remarks %}
                            <hr>
                            <p class="mb-1 text-muted">Remarks</p>
                            <p>{{ enquiry.remarks }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Linked Proposal Request (if converted) -->
                    {% if enquiry.status == 'CONVERTED_TO_PR' and enquiry.linked_pr %}
                    <div class="card mb-4 border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Linked Proposal Request</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>PR Number:</strong>
                                <a href="/proposal-request/{{ enquiry.linked_pr.id }}">
                                    {{ enquiry.linked_pr.pr_number }}
                                </a>
                            </p>
                            <p><strong>Status:</strong> {{ enquiry.linked_pr.status }}</p>
                            <p><strong>Created:</strong> {{ enquiry.linked_pr.created_at }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Activity Log -->
                    {% if activities %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Activity Log</h5>
                        </div>
                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                            {% for act in activities %}
                            <div class="border-start border-3 ps-3 mb-3
                                {% if act.action == 'CREATE' %}border-success
                                {% elif act.action == 'APPROVE' %}border-info
                                {% elif act.action == 'REJECT' %}border-danger
                                {% else %}border-secondary{% endif %}">
                                <small class="text-muted">{{ act.created_at }}</small><br>
                                <strong>{{ act.actor_name or act.actor_id }}</strong> - {{ act.action }}<br>
                                <span class="text-muted">{{ act.remarks }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar -->
                <div class="col-md-4">
                    <!-- Assignment Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Assignment</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Office:</strong><br>
                                {{ enquiry.office_name or enquiry.office_id }}
                            </p>
                            <p class="mb-2">
                                <strong>Created By:</strong><br>
                                {{ enquiry.created_by_name or enquiry.created_by }}
                            </p>
                            <p class="mb-0">
                                <strong>Allocated Officer:</strong><br>
                                {% if enquiry.officer_name %}
                                <span class="text-success">{{ enquiry.officer_name }}</span>
                                {% else %}
                                <span class="text-warning">Not yet allocated</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Approval Info -->
                    {% if enquiry.approval_status != 'PENDING' %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Approval Status</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Status:</strong>
                                <span class="badge {% if enquiry.approval_status == 'APPROVED' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ enquiry.approval_status }}
                                </span>
                            </p>
                            <p class="mb-2">
                                <strong>By:</strong> {{ enquiry.approved_by_name or enquiry.approved_by }}
                            </p>
                            <p class="mb-0">
                                <strong>At:</strong> {{ enquiry.approved_at }}
                            </p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Audit Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Audit Trail</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Created:</strong><br>
                                {{ enquiry.created_at }}<br>
                                <small class="text-muted">by {{ enquiry.created_by_name or enquiry.created_by }}</small>
                            </p>
                            {% if enquiry.updated_at %}
                            <p class="mb-0">
                                <strong>Last Updated:</strong><br>
                                {{ enquiry.updated_at }}
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Workflow Status -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Workflow Progress</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-column">
                                <div class="p-2 mb-2 rounded {% if enquiry.status not in ['DROPPED', 'REJECTED'] %}bg-success text-white{% else %}bg-light{% endif %}">
                                    1. Enquiry {% if enquiry.status not in ['DROPPED', 'REJECTED'] %}✓{% endif %}
                                </div>
                                <div class="p-2 mb-2 rounded {% if enquiry.status == 'CONVERTED_TO_PR' %}bg-success text-white{% else %}bg-light{% endif %}">
                                    2. Proposal Request {% if enquiry.status == 'CONVERTED_TO_PR' %}✓{% endif %}
                                </div>
                                <div class="p-2 mb-2 rounded bg-light">
                                    3. Proposal
                                </div>
                                <div class="p-2 rounded bg-light">
                                    4. Work Order
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Update Modal -->
<div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/enquiry/{{ enquiry.id }}/update-progress">
                <div class="modal-header">
                    <h5 class="modal-title">Update Progress</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Progress Update <span class="text-danger">*</span></label>
                        <textarea name="current_update" class="form-control" rows="4" required
                                  placeholder="Describe the current progress...">{{ enquiry.current_update or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="IN_PROGRESS" {% if enquiry.status == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                            <option value="ON_HOLD" {% if enquiry.status == 'ON_HOLD' %}selected{% endif %}>On Hold</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reallocate Modal -->
<div class="modal fade" id="reallocateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/enquiry/{{ enquiry.id }}/reallocate">
                <div class="modal-header">
                    <h5 class="modal-title">Reallocate Officer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Current Officer: <strong>{{ enquiry.officer_name or 'Not allocated' }}</strong></p>
                    <div class="mb-3">
                        <label class="form-label">New Officer <span class="text-danger">*</span></label>
                        <select name="officer_id" class="form-select" required>
                            <option value="">Select Officer</option>
                            {% for o in officers %}
                            <option value="{{ o.officer_id }}"
                                    {% if enquiry.officer_id == o.officer_id %}selected{% endif %}>
                                {{ o.name }} ({{ o.office_id }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Reallocate</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Drop Modal -->
<div class="modal fade" id="dropModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/enquiry/{{ enquiry.id }}/drop">
                <div class="modal-header">
                    <h5 class="modal-title">Drop Enquiry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to drop this enquiry?</p>
                    <div class="mb-3">
                        <label class="form-label">Reason for dropping <span class="text-danger">*</span></label>
                        <textarea name="drop_reason" class="form-control" rows="3" required
                                  placeholder="Please provide a reason..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Drop Enquiry</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
