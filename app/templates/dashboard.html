{% extends "base.html" %}

{% block title %}Dashboard - NPC PMS Portal{% endblock %}

{% block content %}
<div class="tab-container">
    <!-- Header with Role-Based View -->
    <div class="tab-header">
        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <h1>{{ view_title or 'Dashboard' }}</h1>
            {% if scope_value %}
            <span class="badge badge-info" style="font-size: 0.875rem;">{{ scope_value }}</span>
            {% endif %}
            {% if role_offices %}
            <span style="font-size: 0.75rem; color: #64748b;">
                {{ role_offices|length }} Offices, {{ role_groups|length if role_groups else 0 }} Groups
            </span>
            {% endif %}
        </div>
        <div class="tab-actions">
            <a href="/assignment/select-activity-type" class="btn btn-primary btn-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Activity
            </a>
            <a href="/mis" class="btn btn-secondary btn-sm">MIS</a>
            {% if active_role in ['RD_HEAD', 'GROUP_HEAD', 'DG', 'DDG-I', 'DDG-II', 'ADMIN'] %}
            <a href="/approvals" class="btn btn-warning btn-sm">Approvals</a>
            {% endif %}
        </div>
    </div>

    <!-- Performance Summary based on Role -->
    <div class="stats-row" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
        {% if view == 'individual' %}
        <!-- Individual View -->
        <div style="flex: 1; min-width: 200px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">My Target (Pro-rata)</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">{{ "%.1f"|format(summary.prorata_target or 0) }}L <span style="font-size: 0.75rem; color: #94a3b8;">/ {{ "%.1f"|format(summary.annual_target or 60) }}L</span></div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Real Revenue</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.total_share or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #0891b2, #0e7490); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Notional</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.notional_revenue or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: {% if (summary.achievement_pct or 0) >= 100 %}linear-gradient(135deg, #10b981, #059669){% elif (summary.achievement_pct or 0) >= 75 %}linear-gradient(135deg, #f59e0b, #d97706){% else %}linear-gradient(135deg, #ef4444, #dc2626){% endif %}; border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Achievement</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.0f"|format(summary.achievement_pct or 0) }}%</div>
        </div>
        {% elif view == 'team_leader' %}
        <!-- Team Leader View -->
        <div style="flex: 1; min-width: 200px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Assignments as TL</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">{{ summary.assignment_count or 0 }}</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Total Value</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.total_value or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Revenue Collected</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.total_revenue or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: {% if (summary.achievement_pct or 0) >= 100 %}linear-gradient(135deg, #10b981, #059669){% elif (summary.achievement_pct or 0) >= 75 %}linear-gradient(135deg, #f59e0b, #d97706){% else %}linear-gradient(135deg, #ef4444, #dc2626){% endif %}; border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Collection %</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.0f"|format(summary.achievement_pct or 0) }}%</div>
        </div>
        {% elif view == 'office' %}
        <!-- Office / RD Head View -->
        <div style="flex: 1; min-width: 200px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Office Target (Pro-rata)</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">{{ "%.1f"|format(summary.prorata_target or 0) }}L <span style="font-size: 0.75rem; color: #94a3b8;">/ {{ "%.1f"|format(summary.target or 0) }}L</span></div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Real Revenue</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.total_revenue or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #0891b2, #0e7490); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Notional</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.notional_revenue or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: {% if (summary.achievement_pct or 0) >= 100 %}linear-gradient(135deg, #10b981, #059669){% elif (summary.achievement_pct or 0) >= 75 %}linear-gradient(135deg, #f59e0b, #d97706){% else %}linear-gradient(135deg, #ef4444, #dc2626){% endif %}; border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Achievement</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.0f"|format(summary.achievement_pct or 0) }}%</div>
        </div>
        {% elif view == 'group' %}
        <!-- Group Head View -->
        <div style="flex: 1; min-width: 200px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Assignments in {{ scope_value }}</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">{{ summary.assignment_count or 0 }}</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Total Value</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.total_value or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Revenue</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.total_revenue or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #0891b2, #0e7490); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Offices / Officers</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ summary.office_count or 0 }} / {{ summary.officer_count or 0 }}</div>
        </div>
        {% else %}
        <!-- DDG / DG / NPC View -->
        <div style="flex: 1; min-width: 200px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Target (Pro-rata)</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">{{ "%.1f"|format(summary.prorata_target or 0) }}L <span style="font-size: 0.75rem; color: #94a3b8;">/ {{ "%.1f"|format(summary.target or 0) }}L</span></div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Total Revenue</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.1f"|format(summary.total_contribution or summary.total_revenue or 0) }}L</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Offices / Officers</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ summary.office_count or 0 }} / {{ summary.officer_count or 0 }}</div>
        </div>
        <div style="flex: 1; min-width: 200px; background: {% if (summary.achievement_pct or 0) >= 100 %}linear-gradient(135deg, #10b981, #059669){% elif (summary.achievement_pct or 0) >= 75 %}linear-gradient(135deg, #f59e0b, #d97706){% else %}linear-gradient(135deg, #ef4444, #dc2626){% endif %}; border-radius: 12px; padding: 16px; color: white;">
            <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">Achievement</div>
            <div style="font-size: 1.25rem; font-weight: 700;">{{ "%.0f"|format(summary.achievement_pct or 0) }}%</div>
        </div>
        {% endif %}
    </div>

    <!-- 4-Stage Workflow -->
    <div style="background: #f8fafc; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
        <span style="font-weight: 600; color: #475569; font-size: 0.875rem;">Revenue Pipeline:</span>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <a href="/enquiry/" class="btn btn-sm" style="background: #dbeafe; color: #1d4ed8; border: none; font-size: 0.75rem;">1. Enquiries</a>
            <a href="/proposal-request/" class="btn btn-sm" style="background: #e0f2fe; color: #0369a1; border: none; font-size: 0.75rem;">2. PRs</a>
            <a href="/proposal/" class="btn btn-sm" style="background: #fef3c7; color: #b45309; border: none; font-size: 0.75rem;">3. Proposals</a>
            <a href="/assignment/workorders" class="btn btn-sm" style="background: #d1fae5; color: #047857; border: none; font-size: 0.75rem;">4. Work Orders</a>
        </div>
        <a href="/enquiry/new" class="btn btn-sm btn-primary" style="font-size: 0.75rem;">+ New Enquiry</a>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab-btn="dash" onclick="switchTab('tab-all', 'dash')">
            All <span class="count">{{ assignments|length }}</span>
        </button>
        <button class="tab-btn" data-tab-btn="dash" onclick="switchTab('tab-progress', 'dash')">
            In Progress <span class="count">{{ assignments|selectattr('status', 'equalto', 'In Progress')|list|length }}</span>
        </button>
        <button class="tab-btn" data-tab-btn="dash" onclick="switchTab('tab-completed', 'dash')">
            Completed <span class="count">{{ assignments|selectattr('status', 'equalto', 'Completed')|list|length }}</span>
        </button>
        <button class="tab-btn" data-tab-btn="dash" onclick="switchTab('tab-pipeline', 'dash')">
            Pipeline <span class="count">{{ assignments|selectattr('status', 'equalto', 'Pipeline')|list|length }}</span>
        </button>
    </div>

    <!-- Tab Content: All -->
    <div id="tab-all" class="tab-content active" data-tab-group="dash">
        {% if view in ['npc', 'ddg'] and offices %}
        <div class="filter-bar">
            <form method="GET" action="/dashboard" style="display: flex; gap: 8px; align-items: center;">
                <select name="filter_office" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.8125rem;">
                    <option value="">All Offices</option>
                    {% for office in offices %}
                    <option value="{{ office.office_id }}" {% if filter_office == office.office_id %}selected{% endif %}>{{ office.office_id }} - {{ office.office_name }}</option>
                    {% endfor %}
                </select>
                <select name="filter_status" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.8125rem;">
                    <option value="">All Statuses</option>
                    {% for status in statuses %}
                    <option value="{{ status }}" {% if filter_status == status %}selected{% endif %}>{{ status }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-primary">Filter</button>
                {% if filter_office or filter_status %}
                <a href="/dashboard" class="btn btn-sm btn-secondary">Clear</a>
                {% endif %}
            </form>
        </div>
        {% endif %}

        {% if assignments %}
        <table class="compact-table">
            <thead>
                <tr>
                    <th>Assignment No.</th>
                    <th>Type</th>
                    <th>Title</th>
                    <th>Office</th>
                    <th>Value</th>
                    <th>Received</th>
                    <th>Status</th>
                    <th>Details</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for a in assignments %}
                <tr>
                    <td><a href="/assignment/view/{{ a.id }}" class="link-primary">{{ a.assignment_no }}</a></td>
                    <td>
                        {% if a.type %}
                        <span class="badge {% if a.type == 'ASSIGNMENT' %}badge-info{% elif a.type == 'NON_REVENUE' %}badge-purple{% else %}badge-warning{% endif %}">
                            {{ a.type }}
                        </span>
                        {% else %}
                        <span class="badge badge-secondary">-</span>
                        {% endif %}
                    </td>
                    <td>{{ a.title[:35] }}{% if a.title|length > 35 %}...{% endif %}</td>
                    <td>{{ a.office_id }}</td>
                    <td>{{ "%.1f"|format(a.gross_value or 0) }}L</td>
                    <td style="color: #10b981;">{{ "%.1f"|format(a.amount_received or 0) }}L</td>
                    <td>
                        <span class="badge
                            {% if a.status == 'Completed' %}badge-success
                            {% elif a.status == 'In Progress' %}badge-info
                            {% elif a.status == 'On Hold' %}badge-warning
                            {% else %}badge-secondary{% endif %}">
                            {{ a.status or '-' }}
                        </span>
                    </td>
                    <td>
                        {% if a.details_filled %}
                        <span style="color: #10b981; font-size: 0.75rem;">Filled</span>
                        {% else %}
                        <a href="{% if a.type %}/assignment/edit/{{ a.id }}{% else %}/assignment/select-type/{{ a.id }}{% endif %}" class="btn btn-sm btn-primary" style="font-size: 0.7rem; padding: 2px 8px;">Fill</a>
                        {% endif %}
                    </td>
                    <td><a href="/assignment/view/{{ a.id }}" class="btn btn-sm btn-secondary">View</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state" style="padding: 40px; text-align: center;">
            <h3>No assignments found</h3>
            <p>
                {% if view == 'individual' %}
                You don't have any assignments with revenue share yet.
                {% elif view == 'team_leader' %}
                You are not assigned as Team Leader for any assignment.
                {% elif view == 'group' %}
                No assignments found in the {{ scope_value }} group.
                {% elif view == 'office' %}
                No assignments found in this office.
                {% else %}
                Create your first assignment or adjust filters.
                {% endif %}
            </p>
            <a href="/assignment/new" class="btn btn-primary">New Assignment</a>
        </div>
        {% endif %}
    </div>

    <!-- Tab Content: In Progress -->
    <div id="tab-progress" class="tab-content" data-tab-group="dash">
        <table class="compact-table">
            <thead>
                <tr>
                    <th>Assignment No.</th>
                    <th>Title</th>
                    <th>Office</th>
                    <th>Value</th>
                    <th>Target Date</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for a in assignments if a.status == 'In Progress' %}
                <tr>
                    <td><a href="/assignment/view/{{ a.id }}" class="link-primary">{{ a.assignment_no }}</a></td>
                    <td>{{ a.title[:40] }}{% if a.title|length > 40 %}...{% endif %}</td>
                    <td>{{ a.office_id }}</td>
                    <td>{{ "%.1f"|format(a.gross_value or 0) }}L</td>
                    <td>{{ a.target_date|format_date if a.target_date else '-' }}</td>
                    <td><a href="/assignment/view/{{ a.id }}" class="btn btn-sm btn-primary">View</a></td>
                </tr>
                {% else %}
                <tr><td colspan="6" style="text-align: center; padding: 40px; color: #888;">No assignments in progress</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tab Content: Completed -->
    <div id="tab-completed" class="tab-content" data-tab-group="dash">
        <table class="compact-table">
            <thead>
                <tr>
                    <th>Assignment No.</th>
                    <th>Title</th>
                    <th>Office</th>
                    <th>Value</th>
                    <th>Revenue</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for a in assignments if a.status == 'Completed' %}
                <tr>
                    <td><a href="/assignment/view/{{ a.id }}" class="link-primary">{{ a.assignment_no }}</a></td>
                    <td>{{ a.title[:40] }}{% if a.title|length > 40 %}...{% endif %}</td>
                    <td>{{ a.office_id }}</td>
                    <td>{{ "%.1f"|format(a.gross_value or 0) }}L</td>
                    <td style="color: #10b981;">{{ "%.1f"|format(a.amount_received or 0) }}L</td>
                    <td><a href="/assignment/view/{{ a.id }}" class="btn btn-sm btn-success">View</a></td>
                </tr>
                {% else %}
                <tr><td colspan="6" style="text-align: center; padding: 40px; color: #888;">No completed assignments</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tab Content: Pipeline -->
    <div id="tab-pipeline" class="tab-content" data-tab-group="dash">
        <table class="compact-table">
            <thead>
                <tr>
                    <th>Assignment No.</th>
                    <th>Title</th>
                    <th>Office</th>
                    <th>Value</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for a in assignments if a.status == 'Pipeline' %}
                <tr>
                    <td><a href="/assignment/view/{{ a.id }}" class="link-primary">{{ a.assignment_no }}</a></td>
                    <td>{{ a.title[:40] }}{% if a.title|length > 40 %}...{% endif %}</td>
                    <td>{{ a.office_id }}</td>
                    <td>{{ "%.1f"|format(a.gross_value or 0) }}L</td>
                    <td><a href="/assignment/view/{{ a.id }}" class="btn btn-sm btn-info">View</a></td>
                </tr>
                {% else %}
                <tr><td colspan="5" style="text-align: center; padding: 40px; color: #888;">No assignments in pipeline</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- User Info Footer -->
<div style="text-align: center; padding: 15px; color: #94a3b8; font-size: 0.8125rem;">
    Logged in as <strong>{{ user.name }}</strong> | {{ active_role or 'Officer' }}{% if scope_value %} ({{ scope_value }}){% endif %} | {{ user.office_id }}
</div>
{% endblock %}
