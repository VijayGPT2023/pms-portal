{% extends "base.html" %}

{% block title %}{{ proposal.proposal_number }} - PMS Portal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header with Actions -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="mb-1">{{ proposal.proposal_number }}</h3>
                    <span class="badge
                        {% if proposal.status == 'PENDING_APPROVAL' %}bg-warning
                        {% elif proposal.status in ['APPROVED', 'IN_PROGRESS'] %}bg-info
                        {% elif proposal.status == 'SUBMITTED' %}bg-primary
                        {% elif proposal.status == 'UNDER_REVIEW' %}bg-info
                        {% elif proposal.status == 'SHORTLISTED' %}bg-warning
                        {% elif proposal.status == 'WON' %}bg-success
                        {% elif proposal.status in ['LOST', 'REJECTED', 'DROPPED'] %}bg-danger
                        {% else %}bg-secondary{% endif %} me-2">
                        {{ proposal.status|replace('_', ' ') }}
                    </span>
                    {% if proposal.pr_number %}
                    <span class="text-muted">
                        from <a href="/proposal-request/{{ proposal.pr_id }}">{{ proposal.pr_number }}</a>
                    </span>
                    {% endif %}
                </div>
                <div>
                    {% if proposal.status not in ['WON', 'LOST', 'WITHDRAWN', 'DROPPED', 'REJECTED'] %}
                        {% if can_edit %}
                        <a href="/proposal/{{ proposal.id }}/edit" class="btn btn-outline-primary me-2">Edit</a>
                        {% endif %}
                        {% if (is_allocated_officer or is_head) and proposal.status in ['APPROVED', 'IN_PROGRESS'] %}
                        <button type="button" class="btn btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#progressModal">
                            Update Progress
                        </button>
                        <form method="POST" action="/proposal/{{ proposal.id }}/submit" class="d-inline">
                            <button type="submit" class="btn btn-primary me-2"
                                    onclick="return confirm('Submit this proposal to client?')">
                                Submit to Client
                            </button>
                        </form>
                        {% endif %}
                        {% if proposal.status in ['SUBMITTED', 'UNDER_REVIEW', 'SHORTLISTED'] %}
                        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#wonModal">
                            Mark Won
                        </button>
                        <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#lostModal">
                            Mark Lost
                        </button>
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                            Withdraw
                        </button>
                        {% endif %}
                        {% if is_head %}
                        <button type="button" class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#reallocateModal">
                            Reallocate
                        </button>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#dropModal">
                            Drop
                        </button>
                        {% endif %}
                    {% endif %}
                    <a href="/proposal/" class="btn btn-outline-secondary ms-2">Back to List</a>
                </div>
            </div>

            <!-- Pending Approval Alert (for Heads) -->
            {% if proposal.approval_status == 'PENDING' and is_head %}
            <div class="alert alert-warning mb-4">
                <h5 class="alert-heading">Pending Approval</h5>
                <p>This proposal was created by <strong>{{ proposal.created_by_name or proposal.created_by }}</strong> and requires your approval.</p>
                <hr>
                <form method="POST" action="/proposal/{{ proposal.id }}/approve" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Allocate to Officer <span class="text-danger">*</span></label>
                        <select name="officer_id" class="form-select" required>
                            <option value="">Select Officer</option>
                            {% for o in officers %}
                            <option value="{{ o.officer_id }}" {% if proposal.created_by == o.officer_id %}selected{% endif %}>
                                {{ o.name }} ({{ o.office_id }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-success me-2">Approve & Allocate</button>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
                            Reject
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- Rejection Notice -->
            {% if proposal.status == 'REJECTED' %}
            <div class="alert alert-danger mb-4">
                <h5 class="alert-heading">Proposal Rejected</h5>
                <p><strong>Rejected by:</strong> {{ proposal.approved_by_name or proposal.approved_by }}</p>
                <p><strong>Reason:</strong> {{ proposal.rejection_reason }}</p>
                <p class="mb-0"><strong>Date:</strong> {{ proposal.approved_at }}</p>
            </div>
            {% endif %}

            <!-- Current Progress Update -->
            {% if proposal.current_update %}
            <div class="alert alert-info mb-4">
                <h6 class="alert-heading">Latest Progress Update</h6>
                <p class="mb-0">{{ proposal.current_update }}</p>
                <small class="text-muted">Last updated: {{ proposal.updated_at }}</small>
            </div>
            {% endif %}

            <div class="row">
                <!-- Main Details Card -->
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Proposal Details</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <th style="width: 30%">Client Name</th>
                                    <td>{{ proposal.client_name }}</td>
                                </tr>
                                <tr>
                                    <th>Client Type</th>
                                    <td>{{ proposal.client_type or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Domain</th>
                                    <td>{{ proposal.domain or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Sub-Domain</th>
                                    <td>{{ proposal.sub_domain or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Description / Scope</th>
                                    <td>{{ proposal.description or '-' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Financial Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Financial Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <p class="mb-1 text-muted">Estimated Value</p>
                                    <h4>
                                        {% if proposal.estimated_value %}
                                        Rs. {{ "%.2f"|format(proposal.estimated_value) }} L
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </h4>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-1 text-muted">Proposed Value</p>
                                    <h4>
                                        {% if proposal.proposed_value %}
                                        Rs. {{ "%.2f"|format(proposal.proposed_value) }} L
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </h4>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-1 text-muted">Work Order Value</p>
                                    <h4>
                                        {% if proposal.work_order_value %}
                                        <span class="text-success">Rs. {{ "%.2f"|format(proposal.work_order_value) }} L</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </h4>
                                </div>
                            </div>
                            {% if proposal.target_date %}
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1 text-muted">Target Date</p>
                                    <p><strong>{{ proposal.target_date }}</strong></p>
                                </div>
                            </div>
                            {% endif %}
                            {% if proposal.remarks %}
                            <hr>
                            <p class="mb-1 text-muted">Remarks</p>
                            <p>{{ proposal.remarks }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Linked Work Order (if won) -->
                    {% if proposal.status == 'WON' and proposal.linked_assignment %}
                    <div class="card mb-4 border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Linked Work Order (Assignment)</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Assignment Number:</strong>
                                <a href="/assignment/view/{{ proposal.linked_assignment.id }}">
                                    {{ proposal.linked_assignment.assignment_number }}
                                </a>
                            </p>
                            <p><strong>Status:</strong> {{ proposal.linked_assignment.status }}</p>
                            <p><strong>Sanctioned Value:</strong> Rs. {{ "%.2f"|format(proposal.linked_assignment.sanctioned_value) }} L</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Source Trail -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Source Trail</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% if proposal.enquiry %}
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6>Source Enquiry</h6>
                                            <p><a href="/enquiry/{{ proposal.enquiry.id }}">{{ proposal.enquiry.enquiry_number }}</a></p>
                                            <p class="mb-0 text-muted small">Created: {{ proposal.enquiry.created_at }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if proposal.pr %}
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6>Source Proposal Request</h6>
                                            <p><a href="/proposal-request/{{ proposal.pr.id }}">{{ proposal.pr.pr_number }}</a></p>
                                            <p class="mb-0 text-muted small">Created: {{ proposal.pr.created_at }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    {% if activities %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Activity Log</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for act in activities %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>{{ act.actor_name or act.actor_id }}</strong>
                                            <span class="badge bg-secondary ms-2">{{ act.action }}</span>
                                        </div>
                                        <small class="text-muted">{{ act.created_at }}</small>
                                    </div>
                                    {% if act.remarks %}
                                    <p class="mb-0 mt-1 text-muted small">{{ act.remarks }}</p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar -->
                <div class="col-md-4">
                    <!-- Assignment Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Assignment</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Office:</strong><br>
                                {{ proposal.office_name or proposal.office_id }}
                            </p>
                            <p class="mb-2">
                                <strong>Created By:</strong><br>
                                {{ proposal.created_by_name or proposal.created_by }}
                            </p>
                            <p class="mb-0">
                                <strong>Allocated Officer:</strong><br>
                                {% if proposal.officer_name %}
                                {{ proposal.officer_name }}
                                {% else %}
                                <span class="text-muted fst-italic">Not assigned</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Approval Info -->
                    {% if proposal.approval_status == 'APPROVED' %}
                    <div class="card mb-4 border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">Approval</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Approved By:</strong><br>
                                {{ proposal.approved_by_name or proposal.approved_by }}
                            </p>
                            <p class="mb-0">
                                <strong>Approved At:</strong><br>
                                {{ proposal.approved_at }}
                            </p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Audit Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Audit Trail</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Created:</strong><br>
                                {{ proposal.created_at }}<br>
                                <small class="text-muted">by {{ proposal.created_by_name or proposal.created_by }}</small>
                            </p>
                            {% if proposal.updated_at %}
                            <p class="mb-0">
                                <strong>Last Updated:</strong><br>
                                {{ proposal.updated_at }}
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Workflow Status -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Workflow Status</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-column">
                                <div class="p-2 mb-2 rounded bg-success text-white">
                                    1. Enquiry ✓
                                </div>
                                <div class="p-2 mb-2 rounded bg-success text-white">
                                    2. Proposal Request ✓
                                </div>
                                <div class="p-2 mb-2 rounded {% if proposal.status not in ['WITHDRAWN', 'DROPPED', 'REJECTED'] %}bg-success text-white{% else %}bg-light{% endif %}">
                                    3. Proposal {% if proposal.status not in ['WITHDRAWN', 'DROPPED', 'REJECTED'] %}✓{% endif %}
                                </div>
                                <div class="p-2 rounded {% if proposal.status == 'WON' %}bg-success text-white{% else %}bg-light{% endif %}">
                                    4. Work Order {% if proposal.status == 'WON' %}✓{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Update Modal -->
<div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/proposal/{{ proposal.id }}/update-progress">
                <div class="modal-header">
                    <h5 class="modal-title">Update Progress</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Progress Update <span class="text-danger">*</span></label>
                        <textarea name="current_update" class="form-control" rows="4" required
                                  placeholder="Describe the current status and progress...">{{ proposal.current_update or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="IN_PROGRESS" {% if proposal.status == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                            <option value="ON_HOLD" {% if proposal.status == 'ON_HOLD' %}selected{% endif %}>On Hold</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reallocate Officer Modal -->
<div class="modal fade" id="reallocateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/proposal/{{ proposal.id }}/reallocate">
                <div class="modal-header">
                    <h5 class="modal-title">Reallocate Officer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Current Officer: <strong>{{ proposal.officer_name or 'Not assigned' }}</strong></p>
                    <div class="mb-3">
                        <label class="form-label">New Officer <span class="text-danger">*</span></label>
                        <select name="officer_id" class="form-select" required>
                            <option value="">Select Officer</option>
                            {% for o in officers %}
                            <option value="{{ o.officer_id }}" {% if proposal.officer_id == o.officer_id %}selected{% endif %}>
                                {{ o.name }} ({{ o.office_id }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Reallocate</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/proposal/{{ proposal.id }}/reject">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Reject Proposal</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
                        <textarea name="rejection_reason" class="form-control" rows="3" required
                                  placeholder="Please provide a reason for rejection..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mark Won Modal -->
<div class="modal fade" id="wonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/proposal/{{ proposal.id }}/mark-won">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Mark Proposal as Won</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This will create a Work Order (Assignment) from this proposal.</p>
                    <div class="mb-3">
                        <label class="form-label">Work Order Value (in Lakhs) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">Rs.</span>
                            <input type="number" name="work_order_value" class="form-control" step="0.01" required
                                   value="{{ proposal.proposed_value or proposal.estimated_value or '' }}"
                                   placeholder="0.00">
                            <span class="input-group-text">L</span>
                        </div>
                        <small class="text-muted">Final value as per work order</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Work Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mark Lost Modal -->
<div class="modal fade" id="lostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/proposal/{{ proposal.id }}/mark-lost">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Mark Proposal as Lost</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to mark this proposal as lost?</p>
                    <div class="mb-3">
                        <label class="form-label">Reason <span class="text-danger">*</span></label>
                        <textarea name="loss_reason" class="form-control" rows="3" required
                                  placeholder="Reason for losing the proposal..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Mark as Lost</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div class="modal fade" id="withdrawModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/proposal/{{ proposal.id }}/withdraw">
                <div class="modal-header">
                    <h5 class="modal-title">Withdraw Proposal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to withdraw this proposal?</p>
                    <div class="mb-3">
                        <label class="form-label">Reason for withdrawal <span class="text-danger">*</span></label>
                        <textarea name="withdraw_reason" class="form-control" rows="3" required
                                  placeholder="Reason for withdrawing..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Withdraw</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Drop Modal -->
<div class="modal fade" id="dropModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/proposal/{{ proposal.id }}/drop">
                <div class="modal-header">
                    <h5 class="modal-title">Drop Proposal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to drop this proposal?</p>
                    <div class="mb-3">
                        <label class="form-label">Reason for dropping <span class="text-danger">*</span></label>
                        <textarea name="drop_reason" class="form-control" rows="3" required
                                  placeholder="Please provide a reason..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Drop Proposal</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
